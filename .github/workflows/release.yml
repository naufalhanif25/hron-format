name: Release & Publish

on:
    push:
        branches: ["main"]

jobs:
    release:
        name: Publish NPM & GitHub Release
        runs-on: ubuntu-latest

        permissions:
            contents: write
            packages: write
            id-token: write

        steps:
          - name: Checkout
            uses: actions/checkout@v4
            with:
              fetch-depth: 0

          - name: Install Bun
            uses: oven-sh/setup-bun@v1
            with:
                bun-version: "latest"

          - name: Install dependencies
            run: bun install --retry=5
            env:
              NPM_CONFIG_REGISTRY: https://registry.npmjs.org

          - name: Build project
            run: bun run build

          - name: Configure Git for npm version
            run: |
              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          - name: Bump patch version
            run: |
              NEW_VERSION=$(npm version patch)
              echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
              echo "New version: $NEW_VERSION"

          - name: Commit and push updates
            run: |
              git add package.json package-lock.json || true
              git commit -m "chore: release v${VERSION}" || true
              git pull --rebase origin main
              git push origin main

          - name: Create Tag
            run: |
              git tag "v${VERSION}"
              git push origin "v${VERSION}"

          - name: Publish to NPM
            run: npm publish --provenance --access public

          - name: Create GitHub Release
            uses: softprops/action-gh-release@v2
            with:
              tag_name: "v${{ env.VERSION }}"
              name: "v${{ env.VERSION }}"
              generate_release_notes: true
