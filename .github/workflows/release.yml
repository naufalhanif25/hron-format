name: Release & Publish

on:
    push:
        tags:
          - "v*"

permissions:
    contents: write
    packages: write
    id-token: write

jobs:
    publish:
        name: Publish to NPM & GitHub Release
        environment: production
        runs-on: ubuntu-latest

        steps:
          - name: Checkout
            uses: actions/checkout@v4
            with:
              fetch-depth: 0

          - name: Install Bun
            uses: oven-sh/setup-bun@v1

          - name: Install dependencies
            run: bun install --retry=5
            env:
              NPM_CONFIG_REGISTRY: "https://registry.npmjs.org"

          - name: Build project
            run: bun run build

          - name: Sync version from tag
            run: |
              VERSION="${GITHUB_REF#refs/tags/}"
              VERSION="${VERSION#v}"
              echo "Using version: $VERSION"
              bunx npm version "$VERSION" --no-git-tag-version

          - name: Setup Node for OIDC Publish
            uses: actions/setup-node@v4
            with:
              node-version: 20
              registry-url: "https://registry.npmjs.org"

          - name: Publish to NPM
            run: npm publish --provenance --access public

          - name: Create GitHub Release
            uses: softprops/action-gh-release@v2
            with:
              tag_name: ${{ github.ref_name }}
              name: ${{ github.ref_name }}
              generate_release_notes: true